!function(t,e){"function"==typeof define&&define.amd?define(e):t.Observer=e()}(this,function(){function t(){return this instanceof t?void 0:new t}return t.prototype._topics=null,t.prototype._eventsShouldBubble=!1,t.getBubbleEvents=function(t){return t.split(":").map(function(t,e,n){return n.slice(0,e+1).join(":")})},t.prototype.withEventBubbling=function(){return this._eventsShouldBubble=!0,this},t.prototype._getTopics=function(){return this._topics||(this._topics=Object.create(null)),this._topics},t.prototype._publish=function(t){var e,n,i=this._getTopics()[t],o=Array.prototype.slice.call(arguments,1);if(i){n=i.slice();for(var r=0,s=n.length;s>r;r++)if(e=n[r].handler.apply(n[r].scope||this,o),n[r].once&&i.splice(r,1),e===!1)return!1}return this._eventsShouldBubble},t.prototype.subscribe=function(t,e,n,i){if(t&&"function"==typeof t.toString&&(t=t.toString()),"function"!=typeof e)throw new Error("Observer.subscribe: please provide a function as he handler argument.");var o=this._getTopics();return o[t]||(o[t]=[]),o[t].push({handler:e,scope:n,once:!!i}),this},t.prototype.unsubscribe=function(t,e){t=t&&"function"==typeof t.toString?t.toString():t;var n=this._getTopics();return[].concat(t||Object.keys(n)).forEach(function(t){var i=n[t];i&&(n[t]=i.filter(function(t){return e&&t.scope!==e?t:void 0}),n[t].length||delete n[t])},this),this},t.prototype.publish=function(e){if(!e||"function"!=typeof e.toString)return this;e=e.toString();for(var n,i=t.getBubbleEvents(e),o=Array.prototype.slice.call(arguments,1);i.length&&(n=o.slice(),n.unshift(i[i.length-1]),this._publish.apply(this,n)!==!1);)i.pop();return this},t});
!function(){window.C={}}();
C.extend=function(t,o){function p(){}return p.prototype=o.prototype,t.prototype=new p,t.prototype.constructor=t,t.superclass=o.prototype,t};
!function(){"use strict";function e(e){this.colour=e,this.unicode="black"==e?this.BLACK_UNICODE:this.WHITE_UNICODE}e.prototype.checkLegal=function(e,o,n,r){var t=this._processMoveData(e,o,n,r);return(this.movedBackwards(t)||this.movedSideways(t)||this.movedForwards(t))&&this.clearRouteStraight(t)||this.movedDiagonally(t)&&this.clearRouteDiagonally(t)},e.prototype.clearRouteStraight=function(e){var o=!0,n=C.Engine.ALPHABET.indexOf(e.selectedCoordFile),r=C.Engine.ALPHABET.indexOf(e.newCoordFile);if(e.newCoordRank>e.selectedCoordRank)for(var t=e.selectedCoordRank+1;t<e.newCoordRank&&(o=this.checkForPiece(e.selectedCoordFile+t,e),o);t++);else if(e.newCoordRank<e.selectedCoordRank)for(var t=e.selectedCoordRank-1;t>e.newCoordRank&&(o=this.checkForPiece(e.selectedCoordFile+t,e),o);t--);else if(r>n)for(var t=n+1;r>t&&(o=this.checkForPiece(C.Engine.ALPHABET[t]+e.selectedCoordRank,e),o);t++);else if(n>r)for(var t=n-1;t>r&&(o=this.checkForPiece(C.Engine.ALPHABET[t]+e.selectedCoordRank,e),o);t--);return o},e.prototype.checkForPiece=function(o,n){var r=!0;return n.positions[o]instanceof e&&(r=!1,console.log("there was a blockage",o,n.positions[o])),r},e.prototype.clearRouteDiagonally=function(e){for(var o,n=!0,r=C.Engine.ALPHABET.indexOf(e.selectedCoordFile),t=C.Engine.ALPHABET.indexOf(e.newCoordFile),d=r-1,i=r+1,a=e.selectedCoordRank+1,l=e.selectedCoordRank-1,c=r>t?r-t:t-r,s=1;c>s;s++){if(n=!1,t>r&&e.newCoordRank>e.selectedCoordRank?o=C.Engine.ALPHABET[i]+a:r>t&&e.newCoordRank>e.selectedCoordRank?o=C.Engine.ALPHABET[d]+a:t>r&&e.newCoordRank<e.selectedCoordRank?o=C.Engine.ALPHABET[i]+l:r>t&&e.newCoordRank<e.selectedCoordRank&&(o=C.Engine.ALPHABET[d]+l),n=!(e.positions[o]instanceof C.Piece),!n){console.log("there was a blockage",o,e.positions[o]);break}d--,i++,l--,a++}return n},e.prototype._processMoveData=function(e,o,n,r){return{selectedCoord:e,newCoord:o,selectedCoordRank:+e.slice(1),selectedCoordFile:e.slice(0,1),newCoordFile:o.slice(0,1),newCoordRank:+o.slice(1),turn:n,positions:r}},e.prototype.movedBackwards=function(e){return"white"==e.turn&&e.newCoordRank<e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile||"black"==e.turn&&e.newCoordRank>e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile?(console.log("move was backwards"),!0):!1},e.prototype.movedForwards=function(e){return"white"==e.turn&&e.newCoordRank>e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile||"black"==e.turn&&e.newCoordRank<e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile?(console.log("move was forwards"),!0):!1},e.prototype.movedDiagonally=function(e){var o=C.Engine.ALPHABET,n=Math.abs(o.indexOf(e.selectedCoordFile)-o.indexOf(e.newCoordFile)),r=Math.abs(e.selectedCoordRank-e.newCoordRank);return n==r?(console.log("diagonal move attempted"),!0):!1},e.prototype.movedSideways=function(e){return e.selectedCoordRank==e.newCoordRank},e.prototype.colour=null,e.prototype.BLACK_UNICODE=null,e.prototype.WHITE_UNICODE=null,C.Piece=e}();
!function(){"use strict";function t(){t.superclass.constructor.apply(this,arguments)}C.extend(t,C.Piece),t.prototype.checkLegal=function(t,e,o,s){var r=this._processMoveData(t,e,o,s);return this.movedDiagonally(r)&&this.clearRouteDiagonally(r)},t.prototype.BLACK_UNICODE="♝",t.prototype.WHITE_UNICODE="♗",C.Bishop=t}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,n){var r=this._processMoveData(e,t,o,n),s=C.Engine.ALPHABET,a=Math.abs(s.indexOf(r.selectedCoordFile)-s.indexOf(r.newCoordFile)),c=Math.abs(r.selectedCoordRank-r.newCoordRank);return 1>=a&&1>=c},e.prototype.BLACK_UNICODE="♚",e.prototype.WHITE_UNICODE="♔",C.King=e}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,n){var r=this._processMoveData(e,t,o,n),s=C.Engine.ALPHABET,a=Math.abs(s.indexOf(r.selectedCoordFile)-s.indexOf(r.newCoordFile)),c=Math.abs(r.selectedCoordRank-r.newCoordRank);return 1==a&&2==c||2==a&&1==c?!0:!1},e.prototype.BLACK_UNICODE="♞",e.prototype.WHITE_UNICODE="♘",C.Knight=e}();
!function(){"use strict";function o(){o.superclass.constructor.apply(this,arguments)}C.extend(o,C.Piece),o.prototype.checkLegal=function(o,e,t,n){var r=this._processMoveData(o,e,t,n);return this.movedDiagonally(r)||this.movedForwards(r)&&this.clearRouteStraight(r)},o.prototype.movedForwards=function(o){return"white"==o.turn&&2==o.selectedCoordRank&&4==o.newCoordRank&&o.selectedCoordFile==o.newCoordFile?(console.log("took initial pawn two-coord leap"),!0):"black"==o.turn&&7==o.selectedCoordRank&&5==o.newCoordRank&&o.selectedCoordFile==o.newCoordFile?(console.log("took initial pawn two-coord leap"),!0):"white"==o.turn&&o.newCoordRank-o.selectedCoordRank==1&&o.selectedCoordFile==o.newCoordFile?!0:"black"==o.turn&&o.selectedCoordRank-o.newCoordRank==1&&o.selectedCoordFile==o.newCoordFile?!0:!1},o.prototype.movedDiagonally=function(o){var e,t=C.Engine.ALPHABET,n=Math.abs(t.indexOf(o.selectedCoordFile)-t.indexOf(o.newCoordFile)),r=Math.abs(o.selectedCoordRank-o.newCoordRank);return e="white"==o.turn?o.newCoordRank>o.selectedCoordRank:o.newCoordRank<o.selectedCoordRank,1==n&&1==r&&e&&o.positions[o.newCoord]instanceof C.Piece?!0:!1},o.prototype.clearRouteStraight=function(o){return!(o.positions[o.newCoord]instanceof C.Piece)},o.prototype.BLACK_UNICODE="♟",o.prototype.WHITE_UNICODE="♙",C.Pawn=o}();
!function(){"use strict";function t(){t.superclass.constructor.apply(this,arguments)}C.extend(t,C.Piece),t.prototype.colour=null,t.prototype.BLACK_UNICODE="♛",t.prototype.WHITE_UNICODE="♕",C.Queen=t}();
!function(){"use strict";function t(){t.superclass.constructor.apply(this,arguments)}C.extend(t,C.Piece),t.prototype.checkLegal=function(t,e,o,s){var r=this._processMoveData(t,e,o,s);return(this.movedBackwards(r)||this.movedSideways(r)||this.movedForwards(r))&&this.clearRouteStraight(r)},t.prototype.BLACK_UNICODE="♜",t.prototype.WHITE_UNICODE="♖",C.Rook=t}();
!function(){"use strict";function t(){this.buildPositions()}t.prototype=Object.create(Observer.prototype),t.prototype.positions={},t.prototype.turn="white",t.prototype.makeMove=function(o){var i=o.match(/[a-z]\d/)[0],s=o.match(/[a-z]\d$/)[0];this.checkLegal(i,s)?(this.place(i,s),this.publish(t.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.positions,o,this.turn,i,s),this.changeTurn(this.positions[s].colour)):this.publish(t.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT,this.positions,i,s)},t.prototype.checkLegal=function(t,o){var i=this.positions[t].colour,s=this.positions[o].colour;return this.positions[o]instanceof C.Piece&&this.tookOwnPiece(i,s)||this.tookConsecutiveTurns(i)||!this.positions[t].checkLegal(t,o,this.turn,this.positions)?!1:!0},t.prototype.tookOwnPiece=function(t,o){return t==o?(console.log("can't take own piece"),!0):!1},t.prototype.tookConsecutiveTurns=function(t){return t!=this.turn?(console.log("it is not "+t+"'s turn"),!0):!1},t.prototype.place=function(t,o){this.positions[o]=this.positions[t],this.positions[t]={}},t.prototype.changeTurn=function(t){this.turn="white"==t?"black":"white"},t.prototype.buildPositions=function(){for(var o,i={},s=0;s<t.SQUARES_PER_RANK;s++)for(var e=0;e<t.SQUARES_PER_RANK;e++)i[t.ALPHABET[e]+(t.SQUARES_PER_RANK-s)]={};for(var s=0;s<t.SQUARES_PER_RANK;s++)i[t.ALPHABET[s]+2]=new C.Pawn("white"),i[t.ALPHABET[s]+(t.SQUARES_PER_RANK-1)]=new C.Pawn("black"),o=new C[t.PIECE_ORDER[s]]("white"),i[t.ALPHABET[s]+1]=o,o=new C[t.PIECE_ORDER[s]]("black"),i[t.ALPHABET[s]+t.SQUARES_PER_RANK]=o;this.positions=i},t.prototype.processMoveLog=function(o){for(var i,s,e,n=0;n<o.length;n++)e=o[n],i=e.split(" ")[1].slice(1,3),s=e.split(" ")[1].slice(4,6),this.place(i,s),this.changeTurn("white"),e.split(" ")[2]&&(i=e.split(" ")[2].slice(1,3),s=e.split(" ")[2].slice(4,6),this.place(i,s),this.changeTurn("black"));this.publish(t.MOVELOG_PROCESSED,this.positions,this.turn,o)},t.HUMAN_MOVE_DEEMED_LEGAL_EVENT="humanMoveDeemedLegalEvent",t.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT="humanMoveDeemedIllegalEvent",t.MOVELOG_PROCESSED="moveLogProcessedEvent",t.ALPHABET=["a","b","c","d","e","f","g","h"],t.PIECE_ORDER=["Rook","Knight","Bishop","Queen","King","Bishop","Knight","Rook"],t.SQUARES_PER_RANK=8,C.Engine=t}();
!function(){"use strict";function o(){}o.prototype.handleMoveDeemedLegal=function(o,t,e){this.add(t,e)},o.prototype.handleMoveLogProcessed=function(o,t,e){this.log=e},o.prototype.add=function(o,t){"white"==t?this.log.push(this.log.length+1+". "+o):this.log[this.log.length-1]=this.log[this.log.length-1]+" "+o,console.log(this.log)},o.prototype.log=[],C.MoveLog=o}();
!function(){"use strict";function e(e,t){return this.positions=t,this._boardEl=document.getElementById(e),this._buildCoordMapping(),this._renderPiecesOnBoard(),this._initialiseEvents(),this}e.prototype=Object.create(Observer.prototype),e.prototype._initialiseEvents=function(){this._boardEl.addEventListener("click",this._handleBoardClick.bind(this),!1)},e.prototype.handleMoveDeemedLegal=function(e,t,o,i,s){this._renderPiecesOnBoard(),this._deselectSquares();var r=Array.prototype.slice.call(document.getElementsByClassName("selected"));r.forEach(function(e){e.className=""}),document.getElementById(i).className="selected",document.getElementById(s).className="selected"},e.prototype.handleMoveDeemedIllegal=function(e,t,o){document.getElementById(t).className="",document.getElementById(o).className="",this._deselectSquares()},e.prototype._selectedCoord=null,e.prototype._squareSize=null,e.prototype._borderWidth=0,e.prototype._coordMapping={},e.prototype._buildCoordMapping=function(){this._squareSize=Math.floor(this._boardEl.getAttribute("width")/e.SQUARES_PER_RANK);for(var t=0;t<e.SQUARES_PER_RANK;t++)for(var o=0;o<e.SQUARES_PER_RANK;o++)this._coordMapping[e.ALPHABET[o]+(e.SQUARES_PER_RANK-t)]={x:Math.floor(o*this._squareSize+this._borderWidth),y:Math.floor(t*this._squareSize+this._borderWidth),colour:this._squareColorResolver(o,t)}},e.prototype._handleBoardClick=function(t){var o,i,s,r,n=t.pageX-this._boardEl.offsetLeft,d=t.pageY-this._boardEl.offsetTop;for(s in this.positions)if(o=this._coordMapping[s],i=this.positions[s].constructor.name,this._withinSquare(n,d,o)){var a=this.positions[s]instanceof C.Piece;a||this._selectedCoord?this._selectedCoord&&s===this._selectedCoord?(console.log("same square clicked twice",s),this._deselectSquares()):a&&!this._selectedCoord?(console.log(i,s,"selected"),this._selectedCoord=s,document.getElementById(this._selectedCoord).className="selected"):(!a&&this._selectedCoord||a&&this._selectedCoord)&&(r=this.buildLan(this._selectedCoord,s,a),document.getElementById(s).className="selected",this.publish(e.HUMAN_MOVE_MADE_EVENT,r,!0)):(console.log("empty "+s+" clicked, no piece selected"),this._deselectSquares())}},e.prototype.buildLan=function(e,t,o){var i=o?"x":"-",s=this.positions[e].constructor.name.slice(0,1);return s+=e+i+t},e.prototype.handleMoveLogProcessed=function(e){this.positions=e,this._drawBoard(),this._renderPiecesOnBoard()},e.prototype._deselectSquares=function(){console.log("unselecting square",this._selectedCoord),this._selectedCoord=null},e.prototype._withinSquare=function(e,t,o){return t>o.y&&t<o.y+this._squareSize&&e>o.x&&e<o.x+this._squareSize},e.prototype._renderPiecesOnBoard=function(){this._clearBoard(),this._squareSize=Math.floor(this._boardEl.getAttribute("width")/C.Engine.SQUARES_PER_RANK);for(var e in this.positions){var t=this.positions[e];this._place(t.unicode,e)}},e.prototype._clearBoard=function(){var e=Array.prototype.slice.call(this._boardEl.children);e.forEach(function(e){e.innerHTML=""})},e.prototype._place=function(e,t){if(t){var o=document.createElement("div");o.style.position="absolute";var i=this._coordMapping[t].x,s=this._coordMapping[t].y,r="left:"+i+"px;";r+="top:"+s+"px;",r+="width:"+this._squareSize+"px;",r+="height:"+this._squareSize+"px;",r+="line-height:"+this._squareSize+"px;",o.setAttribute("style",r),o.innerHTML=e||"",o.id=t,this._boardEl.appendChild(o)}},e.prototype._squareColorResolver=function(t,o){return t+o&1?e.DARK_SQUARE_COLOR:e.LIGHT_SQUARE_COLOR},e.SQUARE_TEMPLATE="<span></span>",e.ALPHABET=["a","b","c","d","e","f","g","h"],e.SQUARES_PER_RANK=8,e.DARK_SQUARE_COLOR="#B58863",e.LIGHT_SQUARE_COLOR="#F0D9B5",e.MEN_STROKE_COLOUR="#000",e.MEN_FONT="bold 54px Arial",e.HUMAN_MOVE_MADE_EVENT="humanMadeMoveEvent",C.UI=e}();
!function(){"use strict";function e(){this.engine=new C.Engine,this.UI=new C.UI("chessboard",this.engine.positions),this.movelog=new C.MoveLog,this._initialiseEvents()}e.prototype._initialiseEvents=function(){this.UI.subscribe(C.UI.HUMAN_MOVE_MADE_EVENT,this.engine.makeMove,this.engine),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.UI.handleMoveDeemedLegal,this.UI),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.movelog.handleMoveDeemedLegal,this.movelog),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT,this.UI.handleMoveDeemedIllegal,this.UI),this.engine.subscribe(C.Engine.MOVELOG_PROCESSED,this.UI.handleMoveLogProcessed,this.UI),this.engine.subscribe(C.Engine.MOVELOG_PROCESSED,this.movelog.handleMoveLogProcessed,this.movelog)},C.Chess=new e}();