!function(t,e){"function"==typeof define&&define.amd?define(e):t.Observer=e()}(this,function(){function t(){return this instanceof t?void 0:new t}return t.prototype._topics=null,t.prototype._eventsShouldBubble=!1,t.getBubbleEvents=function(t){return t.split(":").map(function(t,e,n){return n.slice(0,e+1).join(":")})},t.prototype.withEventBubbling=function(){return this._eventsShouldBubble=!0,this},t.prototype._getTopics=function(){return this._topics||(this._topics=Object.create(null)),this._topics},t.prototype._publish=function(t){var e,n,i=this._getTopics()[t],o=Array.prototype.slice.call(arguments,1);if(i){n=i.slice();for(var r=0,s=n.length;s>r;r++)if(e=n[r].handler.apply(n[r].scope||this,o),n[r].once&&i.splice(r,1),e===!1)return!1}return this._eventsShouldBubble},t.prototype.subscribe=function(t,e,n,i){if(t&&"function"==typeof t.toString&&(t=t.toString()),"function"!=typeof e)throw new Error("Observer.subscribe: please provide a function as he handler argument.");var o=this._getTopics();return o[t]||(o[t]=[]),o[t].push({handler:e,scope:n,once:!!i}),this},t.prototype.unsubscribe=function(t,e){t=t&&"function"==typeof t.toString?t.toString():t;var n=this._getTopics();return[].concat(t||Object.keys(n)).forEach(function(t){var i=n[t];i&&(n[t]=i.filter(function(t){return e&&t.scope!==e?t:void 0}),n[t].length||delete n[t])},this),this},t.prototype.publish=function(e){if(!e||"function"!=typeof e.toString)return this;e=e.toString();for(var n,i=t.getBubbleEvents(e),o=Array.prototype.slice.call(arguments,1);i.length&&(n=o.slice(),n.unshift(i[i.length-1]),this._publish.apply(this,n)!==!1);)i.pop();return this},t});
!function(){window.C={}}();
C.extend=function(t,o){function p(){}return p.prototype=o.prototype,t.prototype=new p,t.prototype.constructor=t,t.superclass=o.prototype,t};
!function(){"use strict";function e(e){this.colour=e,this.unicode="black"==e?this.BLACK_UNICODE:this.WHITE_UNICODE}e.prototype.checkLegal=function(o,n,r,d){var t=e.processMoveData(o,n,r,d);return(e.movedBackwards(t)||e.movedSideways(t)||e.movedForwards(t))&&e.clearRouteStraight(t)||e.movedDiagonally(t)&&e.clearRouteDiagonally(t)},e.clearRouteStraight=function(o){var n=!0,r=C.Engine.ALPHABET.indexOf(o.selectedCoordFile),d=C.Engine.ALPHABET.indexOf(o.newCoordFile);if(o.newCoordRank>o.selectedCoordRank)for(var t=o.selectedCoordRank+1;t<o.newCoordRank&&(n=e.checkForPiece(o.selectedCoordFile+t,o),n);t++);else if(o.newCoordRank<o.selectedCoordRank)for(var t=o.selectedCoordRank-1;t>o.newCoordRank&&(n=e.checkForPiece(o.selectedCoordFile+t,o),n);t--);else if(d>r)for(var t=r+1;d>t&&(n=e.checkForPiece(C.Engine.ALPHABET[t]+o.selectedCoordRank,o),n);t++);else if(r>d)for(var t=r-1;t>d&&(n=e.checkForPiece(C.Engine.ALPHABET[t]+o.selectedCoordRank,o),n);t--);return n},e.checkForPiece=function(o,n){var r=!0;return n.positions[o]instanceof e&&(r=!1,console.log("there was a blockage",o,n.positions[o])),r},e.clearRouteDiagonally=function(e){for(var o,n=!0,r=C.Engine.ALPHABET.indexOf(e.selectedCoordFile),d=C.Engine.ALPHABET.indexOf(e.newCoordFile),t=r-1,a=r+1,l=e.selectedCoordRank+1,i=e.selectedCoordRank-1,c=r>d?r-d:d-r,s=1;c>s;s++){if(n=!1,d>r&&e.newCoordRank>e.selectedCoordRank?o=C.Engine.ALPHABET[a]+l:r>d&&e.newCoordRank>e.selectedCoordRank?o=C.Engine.ALPHABET[t]+l:d>r&&e.newCoordRank<e.selectedCoordRank?o=C.Engine.ALPHABET[a]+i:r>d&&e.newCoordRank<e.selectedCoordRank&&(o=C.Engine.ALPHABET[t]+i),n=!(e.positions[o]instanceof C.Piece),!n){console.log("there was a blockage",o,e.positions[o]);break}t--,a++,i--,l++}return n},e.processMoveData=function(e,o,n,r){return{selectedCoord:e,newCoord:o,selectedCoordRank:+e.slice(1),selectedCoordFile:e.slice(0,1),newCoordFile:o.slice(0,1),newCoordRank:+o.slice(1),turn:n,positions:r}},e.movedBackwards=function(e){return"white"==e.turn&&e.newCoordRank<e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile||"black"==e.turn&&e.newCoordRank>e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile?(console.log("move was backwards"),!0):!1},e.movedForwards=function(e){return"white"==e.turn&&e.newCoordRank>e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile||"black"==e.turn&&e.newCoordRank<e.selectedCoordRank&&e.newCoordFile==e.selectedCoordFile?(console.log("move was forwards"),!0):!1},e.movedDiagonally=function(e){var o=C.Engine.ALPHABET,n=Math.abs(o.indexOf(e.selectedCoordFile)-o.indexOf(e.newCoordFile)),r=Math.abs(e.selectedCoordRank-e.newCoordRank);return n==r?(console.log("diagonal move attempted"),!0):!1},e.movedSideways=function(e){return e.selectedCoordRank==e.newCoordRank},e.prototype.colour=null,e.prototype.BLACK_UNICODE=null,e.prototype.WHITE_UNICODE=null,C.Piece=e}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,c){var n=C.Piece.processMoveData(e,t,o,c);return C.Piece.movedDiagonally(n)&&C.Piece.clearRouteDiagonally(n)},e.prototype.BLACK_UNICODE="♝",e.prototype.WHITE_UNICODE="♗",e.prototype.notation="B",C.Bishop=e}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,n){var r=C.Piece.processMoveData(e,t,o,n),a=C.Engine.ALPHABET,c=Math.abs(a.indexOf(r.selectedCoordFile)-a.indexOf(r.newCoordFile)),i=Math.abs(r.selectedCoordRank-r.newCoordRank);return 1>=c&&1>=i},e.prototype.BLACK_UNICODE="♚",e.prototype.WHITE_UNICODE="♔",e.prototype.notation="K",C.King=e}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,n){var r=C.Piece.processMoveData(e,t,o,n),a=C.Engine.ALPHABET,c=Math.abs(a.indexOf(r.selectedCoordFile)-a.indexOf(r.newCoordFile)),i=Math.abs(r.selectedCoordRank-r.newCoordRank);return 1==c&&2==i||2==c&&1==i?!0:!1},e.prototype.BLACK_UNICODE="♞",e.prototype.WHITE_UNICODE="♘",e.prototype.notation="N",C.Knight=e}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(o,n,t,r){var d=C.Piece.processMoveData(o,n,t,r);return e.movedDiagonally(d)||e.movedForwards(d)&&e.clearRouteStraight(d)},e.movedForwards=function(e){return"white"==e.turn&&2==e.selectedCoordRank&&4==e.newCoordRank&&e.selectedCoordFile==e.newCoordFile?(console.log("took initial pawn two-coord leap"),!0):"black"==e.turn&&7==e.selectedCoordRank&&5==e.newCoordRank&&e.selectedCoordFile==e.newCoordFile?(console.log("took initial pawn two-coord leap"),!0):"white"==e.turn&&e.newCoordRank-e.selectedCoordRank==1&&e.selectedCoordFile==e.newCoordFile?!0:"black"==e.turn&&e.selectedCoordRank-e.newCoordRank==1&&e.selectedCoordFile==e.newCoordFile?!0:!1},e.movedDiagonally=function(e){var o,n=C.Engine.ALPHABET,t=Math.abs(n.indexOf(e.selectedCoordFile)-n.indexOf(e.newCoordFile)),r=Math.abs(e.selectedCoordRank-e.newCoordRank);return o="white"==e.turn?e.newCoordRank>e.selectedCoordRank:e.newCoordRank<e.selectedCoordRank,1==t&&1==r&&o&&e.positions[e.newCoord]instanceof C.Piece?!0:!1},e.clearRouteStraight=function(e){return!(e.positions[e.newCoord]instanceof C.Piece)},e.prototype.BLACK_UNICODE="♟",e.prototype.WHITE_UNICODE="♙",e.prototype.notation="P",C.Pawn=e}();
!function(){"use strict";function t(){t.superclass.constructor.apply(this,arguments)}C.extend(t,C.Piece),t.prototype.colour=null,t.prototype.BLACK_UNICODE="♛",t.prototype.WHITE_UNICODE="♕",t.prototype.notation="Q",C.Queen=t}();
!function(){"use strict";function e(){e.superclass.constructor.apply(this,arguments)}C.extend(e,C.Piece),e.prototype.checkLegal=function(e,t,o,c){var r=C.Piece.processMoveData(e,t,o,c);return(C.Piece.movedBackwards(r)||C.Piece.movedSideways(r)||C.Piece.movedForwards(r))&&C.Piece.clearRouteStraight(r)},e.prototype.BLACK_UNICODE="♜",e.prototype.WHITE_UNICODE="♖",e.prototype.notation="R",C.Rook=e}();
!function(){"use strict";function t(){this.buildPositions()}t.prototype=Object.create(Observer.prototype),t.prototype.positions=null,t.prototype.turn="white",t.prototype.makeMove=function(o){var i=o.match(/[a-z]\d/)[0],s=o.match(/[a-z]\d$/)[0];this.checkLegal(i,s)?(this.place(i,s),this.publish(t.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.positions,o,this.turn,i,s),this.changeTurn(this.positions[s].colour)):this.publish(t.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT,this.positions,i,s)},t.prototype.checkLegal=function(t,o){var i=this.positions[t].colour,s=this.positions[o].colour;return this.positions[o]instanceof C.Piece&&this.tookOwnPiece(i,s)||this.tookConsecutiveTurns(i)||!this.positions[t].checkLegal(t,o,this.turn,this.positions)?!1:!0},t.prototype.tookOwnPiece=function(t,o){return t==o?(console.log("can't take own piece"),!0):!1},t.prototype.tookConsecutiveTurns=function(t){return t!=this.turn?(console.log("it is not "+t+"'s turn"),!0):!1},t.prototype.place=function(t,o){this.positions[o]=this.positions[t],this.positions[t]={}},t.prototype.changeTurn=function(t){this.turn="white"==t?"black":"white"},t.prototype.buildPositions=function(){for(var o,i={},s=0;s<t.SQUARES_PER_RANK;s++)for(var e=0;e<t.SQUARES_PER_RANK;e++)i[t.ALPHABET[e]+(t.SQUARES_PER_RANK-s)]={};for(var s=0;s<t.SQUARES_PER_RANK;s++)i[t.ALPHABET[s]+2]=new C.Pawn("white"),i[t.ALPHABET[s]+(t.SQUARES_PER_RANK-1)]=new C.Pawn("black"),o=new C[t.PIECE_ORDER[s]]("white"),i[t.ALPHABET[s]+1]=o,o=new C[t.PIECE_ORDER[s]]("black"),i[t.ALPHABET[s]+t.SQUARES_PER_RANK]=o;this.positions=i},t.prototype.processMoveLog=function(o){for(var i,s,e,n=0;n<o.length;n++)e=o[n],i=e.split(" ")[1].slice(1,3),s=e.split(" ")[1].slice(4,6),this.place(i,s),this.changeTurn("white"),e.split(" ")[2]&&(i=e.split(" ")[2].slice(1,3),s=e.split(" ")[2].slice(4,6),this.place(i,s),this.changeTurn("black"));this.publish(t.MOVELOG_PROCESSED,this.positions,this.turn,o)},t.HUMAN_MOVE_DEEMED_LEGAL_EVENT="humanMoveDeemedLegalEvent",t.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT="humanMoveDeemedIllegalEvent",t.MOVELOG_PROCESSED="moveLogProcessedEvent",t.ALPHABET=["a","b","c","d","e","f","g","h"],t.PIECE_ORDER=["Rook","Knight","Bishop","Queen","King","Bishop","Knight","Rook"],t.SQUARES_PER_RANK=8,C.Engine=t}();
!function(){"use strict";function o(){this.log=[]}o.prototype.handleMoveDeemedLegal=function(o,t,e){this.add(t,e)},o.prototype.handleMoveLogProcessed=function(o,t,e){this.log=e},o.prototype.add=function(o,t){"white"==t?this.log.push(this.log.length+1+". "+o):this.log[this.log.length-1]=this.log[this.log.length-1]+" "+o,console.log(this.log)},o.prototype.log=null,C.MoveLog=o}();
!function(){"use strict";function e(e,t,i){return this._positions=t,this._boardEl=document.getElementById(e),this._boardReversed=i,this._buildCoordMapping(),this._placeAllPiecesOnBoard(),this._renderMarkings(),this._initialiseEvents(),this}e.prototype=Object.create(Observer.prototype),e.prototype.withSwitchControl=function(e){return this._switchControl=document.getElementById(e),this._switchControl.addEventListener("click",this._handleSwitchControlClick.bind(this),!1),this},e.prototype.positions=null,e.prototype._boardReversed=null,e.prototype._selectedCoord=null,e.prototype._squareSize=null,e.prototype._coordMapping=null,e.prototype._initialiseEvents=function(){this._boardEl.addEventListener("click",this._handleBoardClick.bind(this),!1)},e.prototype.handleMoveDeemedLegal=function(e,t,i,s,o){this._place("",s),this._place(e[o].unicode,o),this._deselect();var r=Array.prototype.slice.call(document.getElementsByClassName("selected"));r.forEach(function(e){e.className=""}),this._getEl(s).className="selected",this._getEl(o).className="selected"},e.prototype.handleMoveDeemedIllegal=function(e,t,i){this._getEl(t).className="",this._getEl(i).className="",this._deselect()},e.prototype.handleMoveLogProcessed=function(e){this._positions=e,this._clearBoard(),this._placeAllPiecesOnBoard(),this._renderMarkings()},e.prototype._buildCoordMapping=function(){var t,i,s,o=this._boardReversed?e.ALPHABET.slice().reverse():e.ALPHABET;for(this._coordMapping={},this._squareSize=this._boardEl.getAttribute("width")/e.SQUARES_PER_RANK,this._boardEl.className=this._boardReversed?"reversed":"",t=0;t<e.SQUARES_PER_RANK;t++)for(i=0;i<e.SQUARES_PER_RANK;i++)s=this._boardReversed?e.SQUARES_PER_RANK-(t+1):t,this._coordMapping[o[i]+(e.SQUARES_PER_RANK-t)]={x:i*this._squareSize,y:s*this._squareSize}},e.prototype._handleSwitchControlClick=function(){this._boardReversed=!this._boardReversed,this._buildCoordMapping(),this._placeAllPiecesOnBoard(),this._renderMarkings()},e.prototype._handleBoardClick=function(t){var i,s,o,r,l=t.pageX-this._boardEl.offsetLeft,n=t.pageY-this._boardEl.offsetTop;for(o in this._positions)if(i=this._coordMapping[o],s=this._positions[o].notation,this._withinSquare(l,n,i)){var d=this._positions[o]instanceof C.Piece;d||this._selectedCoord?this._selectedCoord&&o===this._selectedCoord?(console.log("same square clicked twice",o),this._deselect()):d&&!this._selectedCoord?(console.log(s,o,"selected"),this._selectedCoord=o,this._getEl(this._selectedCoord).className="selected"):(!d&&this._selectedCoord||d&&this._selectedCoord)&&(r=this._buildLan(this._selectedCoord,o,d),this._getEl(o).className="selected",this.publish(e.HUMAN_MOVE_MADE_EVENT,r,!0)):(console.log("empty "+o+" clicked, no piece selected"),this._deselect())}},e.prototype._buildLan=function(e,t,i){return this._positions[e].notation+e+(i?"x":"-")+t},e.prototype._deselect=function(){console.log("unselecting square",this._selectedCoord),this._selectedCoord=null},e.prototype._withinSquare=function(e,t,i){return t>i.y&&t<i.y+this._squareSize&&e>i.x&&e<i.x+this._squareSize},e.prototype._placeAllPiecesOnBoard=function(){this._squareSize=this._boardEl.getAttribute("width")/C.Engine.SQUARES_PER_RANK;for(var e in this._positions){var t=this._positions[e];this._place(t.unicode||"",e)}this._selectedCoord&&(this._getEl(this._selectedCoord).className="selected")},e.prototype._renderMarkings=function(){for(var t,i,s,o,r,l,n=!!this._getEl("rank0"),d=0;d<e.SQUARES_PER_RANK;d++)n?(t=this._getEl("rank"+d),i=this._getEl("file"+e.ALPHABET[d])):(t=document.createElement("span"),i=t.cloneNode(),t.className="rank",t.setAttribute("id","rank"+d),i.className="file",i.setAttribute("id","file"+e.ALPHABET[d])),t.innerHTML=d+1+"",i.innerHTML=e.ALPHABET[d],this._boardReversed?(s=this._coordMapping[e.ALPHABET[e.SQUARES_PER_RANK-1]+(d+1)],o=this._coordMapping[e.ALPHABET[d]+e.SQUARES_PER_RANK]):(s=this._coordMapping[e.ALPHABET[0]+(d+1)],o=this._coordMapping[e.ALPHABET[d]+1]),r="left:"+o.x+"px;",l="top:"+s.y+"px;",i.setAttribute("style",r),t.setAttribute("style",l),n||(this._boardEl.appendChild(t),this._boardEl.appendChild(i))},e.prototype._place=function(e,t){var i;if(t)if(this._getEl(t)){i=this._getEl(t),i.innerHTML=e||"";var s="left:"+this._coordMapping[t].x+"px;";s+="top:"+this._coordMapping[t].y+"px;",i.setAttribute("style",s)}else{var s="left:"+this._coordMapping[t].x+"px;";s+="top:"+this._coordMapping[t].y+"px;";var o=document.createElement("div");o.setAttribute("style",s),o.innerHTML=e||"",o.id=t,this._boardEl.appendChild(o)}},e.prototype._getEl=function(e){return this._boardEl.querySelector("#"+e)},e.ALPHABET=["a","b","c","d","e","f","g","h"],e.SQUARES_PER_RANK=8,e.HUMAN_MOVE_MADE_EVENT="humanMadeMoveEvent",C.UI=e}();
!function(){"use strict";function e(){this.engine=new C.Engine,this.UI=new C.UI("chessboard",this.engine.positions,!1).withSwitchControl("switchcontrol"),this.movelog=new C.MoveLog,this._initialiseEvents()}e.prototype._initialiseEvents=function(){this.UI.subscribe(C.UI.HUMAN_MOVE_MADE_EVENT,this.engine.makeMove,this.engine),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.UI.handleMoveDeemedLegal,this.UI),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_LEGAL_EVENT,this.movelog.handleMoveDeemedLegal,this.movelog),this.engine.subscribe(C.Engine.HUMAN_MOVE_DEEMED_ILLEGAL_EVENT,this.UI.handleMoveDeemedIllegal,this.UI),this.engine.subscribe(C.Engine.MOVELOG_PROCESSED,this.UI.handleMoveLogProcessed,this.UI),this.engine.subscribe(C.Engine.MOVELOG_PROCESSED,this.movelog.handleMoveLogProcessed,this.movelog)},C.Chess=new e}();